@page "/Account/Manage"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using Jhooa.UI.Features.Identity.Models
@using Microsoft.Extensions.Localization
@using Jhooa.UI.Features.Identity.Components
@using Microsoft.EntityFrameworkCore

@inject IStringLocalizer<Resources.Identity> Loc
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager
@inject NavigationManager NavigationManager
@inject ApplicationDbContext DbContext

<PageTitle>@Loc["MyAccount"]</PageTitle>

<section class="max-w-screen-xl mx-auto  text-white">
    <h3>@Loc["MyAccount"]</h3>

    @if (Input is not null)
    {
        <EditForm Model="Input" method="post" OnValidSubmit="OnValidSubmitAsync" FormName="login" class="space-y-6">
            <StatusMessage/>
            <DataAnnotationsValidator/>

            <div class="grid grid-cols-2 gap-4">
                <div class="">
                    <JhooaInputText @bind-Value="Input.Lastname" DisplayName="@Loc["LastName"]"
                                    ValidationFor="@(() => Input.Lastname)" Autocomplete="lastname"/>
                    <JhooaInputText @bind-Value="Input.Firstname" DisplayName="@Loc["FirstName"]"
                                    ValidationFor="@(() => Input.Firstname)" Autocomplete="firstname"/>

                    <JhooaInputText @bind-Value="Input.PhoneNumber" DisplayName="@Loc["PhoneNumber"]"
                                    ValidationFor="@(() => Input.PhoneNumber)" Autocomplete="phone"/>
                </div>

                <div class="">
                    <JhooaInputText @bind-Value="Input.Address" DisplayName="@Loc["Address"]"
                                    ValidationFor="@(() => Input.Address)" Autocomplete="address"/>
                    <JhooaInputText @bind-Value="Input.ZipCode" DisplayName="@Loc["ZipCode"]"
                                    ValidationFor="@(() => Input.ZipCode)" Autocomplete="zipcode"/>
                    <JhooaInputText @bind-Value="Input.Country" DisplayName="@Loc["Country"]"
                                    ValidationFor="@(() => Input.Country)" Autocomplete="country"/>
                    <div class="flex items-center space-x-2 mb-8">
                        <InputCheckbox @bind-Value="Input.SubscribeToNewsletter"
                                       class="h-5 w-5 rounded border-gray-300 "/>
                        <label for="subscribetonewsletter" class="">@Loc["SubscribeToNewsletter"]</label>
                    </div>
                </div>

                <button type="submit" class="border-2 border-white p-3 bg-gray-400">@Loc["SaveChanges"]</button>
                <JhooaButtonLink Text="@Loc["ChangePassword"]"
                                 Url="@(NavigationManager.GetUriWithQueryParameters("Account/Manage/ChangePassword", new Dictionary<string, object?>()))"/>

            </div>
        </EditForm>
    }
</section>

@code {
    private ApplicationUser _user = default!;
    private string? _phoneNumber;

    [CascadingParameter] private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm] private InputModel? Input { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        _phoneNumber = await UserManager.GetPhoneNumberAsync(_user);

        Input ??= new InputModel()
        {
            Firstname = _user.FirstName,
            Lastname = _user.LastName,
            Address = _user.Address,
            Country = _user.Country,
            ZipCode = _user.ZipCode,
            PhoneNumber = _phoneNumber!,
            SubscribeToNewsletter = _user.NewsletterActive
        };
    }

    private async Task OnValidSubmitAsync()
    {
        if (Input is not null)
        {
            if (Input.PhoneNumber != _phoneNumber)
            {
                var setPhoneResult = await UserManager.SetPhoneNumberAsync(_user, Input.PhoneNumber);
                if (!setPhoneResult.Succeeded)
                {
                    RedirectManager.RedirectToCurrentPageWithStatus("Error: Failed to set phone number.", HttpContext);
                }
            }

            await DbContext.Users.Where(u => u.Id == _user.Id)
                .ExecuteUpdateAsync(setters =>
                    setters.SetProperty(s => s.FirstName, Input.Firstname)
                        .SetProperty(s => s.LastName, Input.Lastname)
                        .SetProperty(s => s.Address, Input.Address)
                        .SetProperty(s => s.ZipCode, Input.ZipCode)
                        .SetProperty(s => s.Country, Input.Country)
                        .SetProperty(s => s.NewsletterActive, Input.SubscribeToNewsletter));

            await DbContext.SaveChangesAsync();


            await SignInManager.RefreshSignInAsync(_user);
            RedirectManager.RedirectToCurrentPageWithStatus("Your profile has been updated", HttpContext);
        }
    }

    private sealed class InputModel
    {
        [Required(ErrorMessageResourceName = "Required", ErrorMessageResourceType = typeof(Resources.Identity))]
        [StringLength(maximumLength: 100, MinimumLength = 3, ErrorMessageResourceName = "FieldLength", ErrorMessageResourceType = typeof(Resources.Identity))]
        public required string Firstname { get; set; }

        [Required(ErrorMessageResourceName = "Required", ErrorMessageResourceType = typeof(Resources.Identity))]
        [StringLength(maximumLength: 100, MinimumLength = 3, ErrorMessageResourceName = "FieldLength", ErrorMessageResourceType = typeof(Resources.Identity))]
        public required string Lastname { get; set; }

        [Required(ErrorMessageResourceName = "Required", ErrorMessageResourceType = typeof(Resources.Identity))]
        [StringLength(maximumLength: 100, MinimumLength = 3, ErrorMessageResourceName = "FieldLength", ErrorMessageResourceType = typeof(Resources.Identity))]
        public required string Address { get; set; }

        [Required(ErrorMessageResourceName = "Required", ErrorMessageResourceType = typeof(Resources.Identity))]
        [StringLength(maximumLength: 100, MinimumLength = 3, ErrorMessageResourceName = "FieldLength", ErrorMessageResourceType = typeof(Resources.Identity))]
        public required string ZipCode { get; set; }

        [Required(ErrorMessageResourceName = "Required", ErrorMessageResourceType = typeof(Resources.Identity))]
        [StringLength(maximumLength: 100, MinimumLength = 3, ErrorMessageResourceName = "FieldLength", ErrorMessageResourceType = typeof(Resources.Identity))]
        public required string Country { get; set; }

        [Required(ErrorMessageResourceName = "Required", ErrorMessageResourceType = typeof(Resources.Identity))]
        [StringLength(maximumLength: 100, MinimumLength = 3, ErrorMessageResourceName = "FieldLength", ErrorMessageResourceType = typeof(Resources.Identity))]
        public required string PhoneNumber { get; set; }

        public bool SubscribeToNewsletter { get; set; }
    }

}
