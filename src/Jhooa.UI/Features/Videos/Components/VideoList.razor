@using Jhooa.UI.Features.Videos.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Localization
@inject ApplicationDbContext DbContext
@inject IStringLocalizer<Resources.Videos> Loc

<div class="mt-8 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
    @if (_videos.Count == 0)
    {
        <p>@Loc["NoVideosFound"]</p>
    }
    else
    {
        @foreach (var video in _videos)
        {
            <div class="relative group">
                <div class="aspect-video">
                    <iframe
                        src="https://player.vimeo.com/video/@video.VideoUrl"
                        class="w-full h-full rounded-md"
                        frameborder="0"
                        allow="autoplay; fullscreen; picture-in-picture"
                        allowfullscreen
                    ></iframe>
                </div>
            </div>
        }
    }
    
</div>

@code {
    
    [Parameter] public Guid? SelectedTheme { get; set; }
    [Parameter] public int? SelectedYear { get; set; }
    [Parameter] public int? SelectedMonth { get; set; }
    
    private List<Video> _videos = [];
    
    protected override async Task OnInitializedAsync()
    {
        _videos = await DbContext.Videos.ToListAsync();
    }
    
    protected override async Task OnParametersSetAsync()
    {
        var query = DbContext.Videos.AsQueryable();
        
        if (SelectedTheme is not null)
        {
            query = query.Include(i => i.Themes).Where(v => v.Themes.Any(t => t.Id == SelectedTheme));
        }
        
        if (SelectedYear is not null)
        {
            query = query.Where(v => v.Date.Year == SelectedYear);
        }
        
        if (SelectedMonth is not null)
        {
            query = query.Where(v => v.Date.Month == SelectedMonth);
        }
        
        _videos = await query.ToListAsync();
    }
}