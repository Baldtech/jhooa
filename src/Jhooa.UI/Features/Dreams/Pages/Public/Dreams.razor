@page "/Account/Manage/Dreams"
@attribute [Authorize]
@layout AccountLayout

@using System.ComponentModel.DataAnnotations
@using Jhooa.UI.Features.Dreams.Models
@using Jhooa.UI.Features.Identity
@using Jhooa.UI.Features.Identity.Models
@using Jhooa.UI.Features.Identity.Shared
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Localization
@using Jhooa.UI.Features.Identity.Components

@inject IStringLocalizer<Resources.Dreams> Loc
@inject IdentityUserAccessor UserAccessor
@inject ApplicationDbContext DbContext

<PageTitle>@Loc["MyDreams"]</PageTitle>

<ManageNavMenu/>

<section class="max-w-screen-xl mx-auto  text-white">
    <h3>@Loc["AttemptToTitle"]</h3>
    <p>@Loc["AttemptToDesc"]</p>

@if (Input is not null)
{
    <EditForm Model="Input" method="post" OnValidSubmit="OnValidSubmitAsync" FormName="login" class="space-y-6">
        <StatusMessage/>
        <DataAnnotationsValidator/>

        <div class="grid grid-cols-1 gap-4">
            <div class="">
                <JhooaInputText @bind-Value="Input.SmallDream" DisplayName="@Loc["SmallDream"]"
                                ValidationFor="@(() => Input.SmallDream)" Autocomplete=""/>
                <JhooaInputText @bind-Value="Input.MediumDream" DisplayName="@Loc["MediumDream"]"
                                ValidationFor="@(() => Input.MediumDream)" Autocomplete=""/>
                <JhooaInputText @bind-Value="Input.BigDream" DisplayName="@Loc["BigDream"]"
                                ValidationFor="@(() => Input.BigDream)" Autocomplete=""/>
            </div>
            
            <button type="submit" class="border-2 border-white p-3 bg-gray-400">@Loc["SaveChanges"]</button>

        </div>
    </EditForm>
}
</section>

@code {
    private ApplicationUser _user = default!;

    [SupplyParameterFromForm] private InputModel? Input { get; set; }

    [CascadingParameter] private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        _user = await UserAccessor.GetRequiredUserAsync(HttpContext);

        if (Input is null)
        {
            var dreams = await DbContext.Dreams.Where(d => d.UserId == _user.Id).ToListAsync();

            Input = new InputModel
            {
                SmallDream = dreams.First(d => d.Type == DreamTypes.Small).Title,
                MediumDream = dreams.First(d => d.Type == DreamTypes.Medium).Title,
                BigDream = dreams.First(d => d.Type == DreamTypes.Big).Title
            };
        }
    }

    private async Task OnValidSubmitAsync()
    {
        await UpdateDream(DreamTypes.Small, Input!.SmallDream);
        await UpdateDream(DreamTypes.Medium, Input!.MediumDream);
        await UpdateDream(DreamTypes.Big, Input!.BigDream);

        await DbContext.SaveChangesAsync();
    }


    private async Task UpdateDream(DreamTypes type, string newDream)
    {
        await DbContext.Dreams.Where(d => d.UserId == _user.Id && d.Type == type).ExecuteDeleteAsync();


        if (!string.IsNullOrWhiteSpace(newDream))
        {
            DbContext.Dreams.Add(new Dream
            {
                Title = newDream,
                Type = type,
                UserId = _user.Id
            });
        }
    }

    private sealed class InputModel
    {
        [Required(ErrorMessageResourceName = "Required", ErrorMessageResourceType = typeof(Resources.Dreams))]
        [StringLength(maximumLength: 100, MinimumLength = 3, ErrorMessageResourceName = "FieldLength", ErrorMessageResourceType = typeof(Resources.Dreams))]
        public string SmallDream { get; set; } = "";

        [Required(ErrorMessageResourceName = "Required", ErrorMessageResourceType = typeof(Resources.Dreams))]
        [StringLength(maximumLength: 100, MinimumLength = 3, ErrorMessageResourceName = "FieldLength", ErrorMessageResourceType = typeof(Resources.Dreams))]
        public string MediumDream { get; set; } = "";

        [Required(ErrorMessageResourceName = "Required", ErrorMessageResourceType = typeof(Resources.Dreams))]
        [StringLength(maximumLength: 100, MinimumLength = 3, ErrorMessageResourceName = "FieldLength", ErrorMessageResourceType = typeof(Resources.Dreams))]
        public string BigDream { get; set; } = "";
    }

}